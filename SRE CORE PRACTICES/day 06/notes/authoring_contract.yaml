authoring_contract:
  response_schema:
    headings_in_order:
      - "🎯 Learning Objective"
      - "✅ Takeaway"
      - "🚦 Applied Example"    # <-- New section for real-world examples
      - "Teaching Narrative"     # <-- Renamed from Prose
      - "Image Embed"          # This section will now contain a reference to external image data
    heading_content_schema: # Define the expected structure under each heading type in the main content YAML
      "🎯 Learning Objective": {type: string, description: "The learning objective for the chapter or section."}
      "✅ Takeaway":           {type: string, description: "The key takeaway or summary of the chapter or section."}
      "🚦 Applied Example": # Schema for the new Applied Example block
        type: object
        required:
          - query_log_snippet # Key for the technical snippet
          - user_impact_note # Key for the user impact
        properties:
          query_log_snippet: {type: string, description: "A real-world query, log sample, or incident snippet (fenced code block recommended).", format: "code"}
          user_impact_note: {type: string, description: "A one-line note explaining the user impact of the example."}
        description: "A block showing a real query, log sample, or incident snippet with a 1-line user impact note, directly after each Takeaway."
      "Teaching Narrative":    {type: string, description: "Detailed narrative prose content focusing on teaching."}
      "Image Embed":
        type: object # Expecting a YAML object (key-value pair) to reference external panel data
        required: [panel_id]
        properties:
          panel_id: {type: integer, description: "References a panel definition by its unique 'panel' identifier in the external image data file."}

  # Removed panel_json_schema as the schema for panel data is defined in the external_image_data_schema section

  prose_requirements:
    word_band: {min: 7800, max: 10000, description: "The total word count for the entire novella's prose content."}
    chunk_size: {min: 400, max: 600, description: "The target word count range for each individual prose block."}
    storytelling_ratio: # Replaces tech_scene_ratio to emphasize narrative balance
      description: |
        Each Teaching Narrative block must balance technical instruction with scene-setting and storytelling.
        The scene-setting and storytelling content should be at least 20 % but not exceed 40 % to ensure sufficient technical depth.
      min_scene_pct: 20
      max_scene_pct: 40
    banking_context_anchor: # New rule to enforce banking relevance - moved description under the key
      value: true
      description: "Ensures that each major unit or section of content is clearly tied back to banking industry concepts or examples."
    voice_guideline: # New rules for mandatory persona elements
      description: "Specific elements that must be included in the narrative voice."
      must_include_per_unit:  # at least one element per Teaching Narrative
        - "Swahili proverb"
        - "Wrist-Slap Moment"
    perspective: "second-person teacher + narrative examples"
    prose_style: |
      Fully narrative, conversational, detailed, and engaging. The conversational tone should feel like a mentor directly speaking to the reader, incorporating dialogue-rich examples and anecdotes. Explicitly avoid bullet points or lists unless necessary.
      Integrate storytelling elements, vivid descriptions, and Kenyan analogies or cultural references where appropriate, fulfilling the voice guidelines.
      # Removed duplicate description key here

  format_rules:
    markdown_image_embed:
      description: |
        After every Image Embed section (which references a panel ID from the external image data file), include a Markdown image reference line using the filename from the referenced panel:
        ![Alt text](images/&lt;filename&gt;){width=&lt;px&gt;}
      check: "Each Image Embed section in the main content YAML must be immediately followed by a matching Markdown image line referencing the correct filename from the external data."
    cadence:
      description: "The overall flow of content sections, starting with introductory elements, followed by alternating Teaching Narrative blocks and Image Embeds."
      pattern_hint: "LO → Takeaway → Applied Example → (Teaching Narrative → Image Embed)+" # Hint for the overall sequence structure
      max_consecutive_prose: # Moved description under the key
        value: 1
        description: "Maximum number of consecutive Teaching Narrative blocks allowed."
      max_consecutive_images: # Moved description under the key
        value: 1
        description: "Maximum number of consecutive Image Embed sections allowed."
    panel_ratio:
      min_images: 6
      max_images: 15
      description: "The minimum and maximum number of static image panels required for the entire novella."
      check: "Total panel definitions in the external image data file must satisfy min_images ≤ n ≤ max_images and each must be referenced by an Image Embed section in the main content YAML."
    allowed_inline_widgets: # New rule for allowed inline elements
      - "SRE Wisdom Box"          # fenced block :::wisdom ... :::
      - "Error Budget Meter"      # :::budget ... :::
      - "Wrist-Slap Moment"       # :::slap ... :::
      - "Nairobi Proverb"         # :::proverb ... :::
      - "Try This"                # :::exercise ... :::
      - "Diagram"                 # fenced ```mermaid``` or image
    widget_syntax_hint: | # Hint for how to format inline widgets
      Use containers like
        :::wisdom
        **SRE Wisdom:** "Reliability you can measure ..."
        :::

  visual_guidelines:
    palette_style_ref: "house_palette_line_style.md"
    description: "Reference file for the visual color palette and line style."
    prefer_diagrams: "mermaid" # Note: Mermaid diagrams are inline and don't use the external JSON file for definition
    character_presence:
      primary: "ava"
      rule: "At least 50 % of panels defined in the external image data file include Ava to anchor teaching voice"
      description: "Rule for including the primary character Ava in a majority of static panels."

  # Section describing the schema of the external image data file (kept from previous version)
  external_image_data_schema:
    description: |
      A separate file (e.g., JSON) will contain an array of panel definitions that will be used by an external application to generate images. The structure and required fields for each panel object within this file are defined here.
    file_format: "JSON (array of objects)"
    array_name: "panels"
    items:
      type: object
      required:
        - panel
        - filename
        - scene_description
        - speech_bubbles
        - narration
      properties:
        panel:
          type: integer
          description: "The unique identifier for the panel in sequence across the entire novella. This ID is used for referencing from the main content YAML."
        filename:
          type: string
          description: "The suggested filename for the generated image file (e.g., chXX_pNN_description.png). This filename is used in the Markdown image reference in the main content YAML."
        scene_description:
          type: string
          description: "A clear and detailed description of the visual scene for image generation, including environment, character actions/expressions, and any on-screen text or labels."
        speech_bubbles:
          type: object
          description: "Dialogue text for characters within the panel, keyed by character name or identifier."
          # Detailed schema for speech_bubbles content can be added here if needed
        narration:
          type: string
          description: "Optional narration text that appears within the panel itself (distinct from prose narration)."
          nullable: true

  consistency_checklist:
    - "Headings present & in required order in the main content YAML (Learning Objective, Takeaway, Applied Example, Teaching Narrative, Image Embed)" # Updated headings check
    - "Word count within 7800–10000 band in the main content YAML prose"
    - "Cadence pattern reflects the sequence of Learning Objective, Takeaway, Applied Example, and alternating Teaching Narrative/Image Embed blocks" # Updated cadence check
    - "Image count 6–15 in the external image data file's panels array"
    - "Mermaid diagrams as 'inline diagrams' that don't count against the static-panel quota (these appear directly as code blocks in the main content YAML, not in the external data file)"
    - "Image Embed sections in main content YAML reference existing panels by 'panel_id' in the external image data file"
    - "Each panel definition object in the external image data file's 'panels' array matches the external_image_data_schema"
    - "Each Image Embed section in the main content YAML is immediately followed by a matching Markdown image line referencing the correct filename from the external data"
    - "Mermaid blocks compile correctly (if used in the main content YAML)"
    - "Ava appears in ≥ 50 % of panels defined in the external image data file's 'panels' array"
    - "Teaching Narrative blocks meet storytelling_ratio (20-40% scene)"
    - "Banking context anchor is present per unit/section" # New checklist item for banking relevance
    - "Voice guideline elements (Swahili proverb OR Wrist-Slap Moment) are included per unit/section" # New checklist item for voice elements
    - "Applied Example block is present directly after each Takeaway and matches its schema" # New checklist item for Applied Example
    - "Teaching Narrative explicitly detailed, narrative, conversational, without superficial summaries or excessive bullet points in the main content YAML" # Updated heading name
    - "Only whitelisted widgets appear, using correct container syntax"

  ambiguity_handling:
    explicit_instruction: |
      If uncertain about the level of detail required, how to reference external image data using 'panel_id', how to use inline widgets, how to apply storytelling/banking context/voice guidelines, or any other rule, explicitly pause and request clarification—never default to condensed or overly summarized output.

  escalation_rule: |
    If any checklist item fails, return the checklist table with ❌ items and halt content generation until resolved.